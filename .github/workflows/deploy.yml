name: Deploy to AWS

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  id-token: write  # Required for AWS OIDC
  contents: read

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "22"
  PNPM_VERSION: "9.15.4"

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable pnpm via Corepack
        shell: bash
        run: |
          corepack enable
          corepack prepare pnpm@${{ env.PNPM_VERSION }} --activate
          pnpm --version

      - name: Setup pnpm cache
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
          cache-dependency-path: "**/pnpm-lock.yaml"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Type check
        run: pnpm typecheck

      - name: Build application
        run: pnpm build
        env:
          NODE_ENV: production

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            dist/
            client/dist/
          retention-days: 7

  deploy-preview:
    name: Deploy Preview (PR)
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: GitHubActions-Deploy-Preview

      - name: Deploy to S3 Preview
        run: |
          PREVIEW_PATH="previews/pr-${{ github.event.pull_request.number }}"
          aws s3 sync client/dist/ s3://${{ secrets.S3_BUCKET }}/${PREVIEW_PATH}/ \
            --delete \
            --cache-control "public, max-age=3600" \
            --metadata-directive REPLACE

      - name: Comment preview URL on PR
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = `https://${{ secrets.CLOUDFRONT_DOMAIN }}/previews/pr-${{ github.event.pull_request.number }}/`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üöÄ Preview deployed!\n\n**URL**: ${previewUrl}\n\nThis preview will be available until the PR is closed or merged.`
            });

  deploy-production:
    name: Deploy Production (main)
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    timeout-minutes: 20
    environment:
      name: production
      url: https://${{ secrets.CLOUDFRONT_DOMAIN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: GitHubActions-Deploy-Production

      - name: Deploy to S3 Production
        run: |
          aws s3 sync client/dist/ s3://${{ secrets.S3_BUCKET }}/ \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "*.html" \
            --exclude "*.json"
          
          # HTML and manifest files with shorter cache
          aws s3 sync client/dist/ s3://${{ secrets.S3_BUCKET }}/ \
            --exclude "*" \
            --include "*.html" \
            --include "*.json" \
            --cache-control "public, max-age=300" \
            --metadata-directive REPLACE

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"

      - name: Deployment summary
        run: |
          echo "‚úÖ Deployment successful!"
          echo "üåê Production URL: https://${{ secrets.CLOUDFRONT_DOMAIN }}"
          echo "üì¶ Commit: ${{ github.sha }}"
          echo "üë§ Deployed by: ${{ github.actor }}"

  smoke-test:
    name: Smoke Test Production
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for CloudFront propagation
        run: sleep 30

      - name: Test homepage loads
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://${{ secrets.CLOUDFRONT_DOMAIN }}/)
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå Homepage returned $HTTP_CODE"
            exit 1
          fi
          echo "‚úÖ Homepage loads successfully (200)"

      - name: Test API health endpoint
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://${{ secrets.CLOUDFRONT_DOMAIN }}/api/health || echo "000")
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ö†Ô∏è  API health check returned $HTTP_CODE (non-critical)"
          else
            echo "‚úÖ API health check passed (200)"
          fi

      - name: Test static assets load
        run: |
          # Try to fetch a common asset path
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://${{ secrets.CLOUDFRONT_DOMAIN }}/assets/ || echo "000")
          if [ "$HTTP_CODE" = "403" ] || [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Static assets path accessible"
          else
            echo "‚ö†Ô∏è  Static assets returned $HTTP_CODE"
          fi

      - name: Smoke test summary
        run: |
          echo "üß™ Smoke tests completed"
          echo "See docs/DEPLOY_SMOKE_CHECK.md for manual verification steps"
