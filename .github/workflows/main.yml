name: CI (tests + release gate)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-and-gate:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    # Provide a DB for DB-backed tests (MySQL-compatible).
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: yeto_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=20

    env:
      # Adjust if your code expects a different format.
      DATABASE_URL: mysql://root:root@127.0.0.1:3306/yeto_test

      # Make CI deterministic
      CI: "true"
      NODE_ENV: "test"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1) Setup Node WITHOUT cache first (pnpm doesn't exist yet)
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      # 2) Enable pnpm via Corepack BEFORE any caching
      - name: Enable pnpm via Corepack
        shell: bash
        run: |
          corepack enable
          corepack prepare pnpm@9.15.4 --activate
          pnpm --version

      # 3) Now that pnpm exists, setup caching
      - name: Setup pnpm cache
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"
          cache-dependency-path: "**/pnpm-lock.yaml"

      - name: Install deps
        run: pnpm install --frozen-lockfile

      # Optional but strongly recommended if your tests rely on schema existing.
      # If your repo uses a different DB command, replace this with the correct one.
      - name: Apply DB schema (drizzle)
        shell: bash
        run: |
          if pnpm -s run | grep -q "db:push"; then
            pnpm db:push
          elif pnpm -s run | grep -q "db:migrate"; then
            pnpm db:migrate
          else
            echo "No db:push or db:migrate script found; skipping schema apply."
          fi

      # Seed the database with test data for CI
      - name: Seed CI test data
        shell: bash
        run: node scripts/seed-ci.mjs

      # Install ESLint dependencies
      - name: Install ESLint dependencies
        run: |
          pnpm add -D eslint @eslint/js @typescript-eslint/parser @typescript-eslint/eslint-plugin eslint-plugin-react eslint-plugin-react-hooks

      # Lint code with ESLint
      - name: Lint (ESLint)
        run: pnpm lint
        continue-on-error: false

      # Typecheck with TypeScript
      - name: Typecheck
        run: pnpm typecheck

      # Lint source registry data
      - name: Registry Lint
        run: pnpm registry:lint
        continue-on-error: true

      # Run unit tests with one retry and capture logs to help diagnose flakes.
      - name: Unit tests (with retry + log)
        shell: bash
        run: |
          set -o pipefail
          mkdir -p artifacts
          (pnpm test 2>&1 | tee artifacts/test.log) || (
            echo "First test run failed; retrying once..." | tee -a artifacts/test.log
            pnpm test 2>&1 | tee -a artifacts/test.log
          )

      - name: Upload test logs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: artifacts/test.log

      # Run integration tests (tests that end with .integration.test.ts)
      - name: Integration tests
        shell: bash
        run: pnpm test -- --run integration
        continue-on-error: true

      # Install Playwright browsers for E2E tests
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      # Run E2E tests with Playwright
      - name: E2E tests (Playwright)
        run: pnpm test:e2e
        continue-on-error: true

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/

      # Run comprehensive release gate
      - name: Release Gate (17 checks)
        run: node scripts/release-gate.mjs
