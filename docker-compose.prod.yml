# YETO Platform - Production Docker Compose Override
# Yemen Economic Transparency Observatory
# 
# Usage: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# This file overrides development settings for production deployment

version: '3.8'

services:
  # ==========================================================================
  # Production Web Application
  # ==========================================================================
  web:
    build:
      args:
        NODE_ENV: production
    container_name: yeto-web-prod
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - JWT_SECRET=${JWT_SECRET}
      - VITE_APP_ID=${VITE_APP_ID}
      - VITE_APP_TITLE=${VITE_APP_TITLE:-YETO}
      - VITE_APP_LOGO=${VITE_APP_LOGO:-/yeto-logo.svg}
      - OAUTH_SERVER_URL=${OAUTH_SERVER_URL}
      - VITE_OAUTH_PORTAL_URL=${VITE_OAUTH_PORTAL_URL}
      - OWNER_OPEN_ID=${OWNER_OPEN_ID}
      - OWNER_NAME=${OWNER_NAME}
      - BUILT_IN_FORGE_API_URL=${BUILT_IN_FORGE_API_URL}
      - BUILT_IN_FORGE_API_KEY=${BUILT_IN_FORGE_API_KEY}
      - VITE_FRONTEND_FORGE_API_KEY=${VITE_FRONTEND_FORGE_API_KEY}
      - VITE_FRONTEND_FORGE_API_URL=${VITE_FRONTEND_FORGE_API_URL}
      - VITE_ANALYTICS_ENDPOINT=${VITE_ANALYTICS_ENDPOINT}
      - VITE_ANALYTICS_WEBSITE_ID=${VITE_ANALYTICS_WEBSITE_ID}
      - S3_ENDPOINT=${S3_ENDPOINT}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
      - S3_BUCKET=${S3_BUCKET:-yeto-storage}
    volumes: []  # Remove development volume mounts
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.yeto.rule=Host(`${DOMAIN:-yeto.causewaygrp.com}`)"
      - "traefik.http.routers.yeto.entrypoints=websecure"
      - "traefik.http.routers.yeto.tls=true"
      - "traefik.http.routers.yeto.tls.certresolver=letsencrypt"
      - "traefik.http.services.yeto.loadbalancer.server.port=3000"
      - "traefik.http.middlewares.yeto-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.yeto-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.yeto-headers.headers.stsPreload=true"
      - "traefik.http.middlewares.yeto-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.yeto-headers.headers.frameDeny=true"
      - "traefik.http.routers.yeto.middlewares=yeto-headers"

  # ==========================================================================
  # Production Database Configuration
  # ==========================================================================
  db:
    container_name: yeto-db-prod
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
      - MYSQL_DATABASE=${DB_NAME:-yeto}
      - MYSQL_USER=${DB_USER:-yeto}
      - MYSQL_PASSWORD=${DB_PASSWORD}
    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --default-authentication-plugin=mysql_native_password
      --max_connections=500
      --innodb_buffer_pool_size=1G
      --innodb_log_file_size=256M
      --innodb_flush_log_at_trx_commit=2
      --slow_query_log=1
      --slow_query_log_file=/var/log/mysql/slow.log
      --long_query_time=2
    volumes:
      - yeto-db-data-prod:/var/lib/mysql
      - yeto-db-logs:/var/log/mysql
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

  # ==========================================================================
  # Production Redis Configuration
  # ==========================================================================
  redis:
    container_name: yeto-redis-prod
    command: >
      redis-server
      --appendonly yes
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --requirepass ${REDIS_PASSWORD:-}
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # ==========================================================================
  # Traefik Reverse Proxy (Production)
  # ==========================================================================
  traefik:
    image: traefik:v2.10
    container_name: yeto-traefik
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/dynamic:/etc/traefik/dynamic:ro
      - traefik-certs:/letsencrypt
    networks:
      - yeto-network
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL:-admin@causewaygrp.com}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      - "--log.level=WARN"
      - "--accesslog=true"
      - "--accesslog.filepath=/var/log/traefik/access.log"
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

  # ==========================================================================
  # Disable Development-Only Services
  # ==========================================================================
  minio:
    profiles:
      - never  # Disable in production (use external S3)

  minio-setup:
    profiles:
      - never

  opensearch:
    profiles:
      - never  # Use managed service in production

  opensearch-dashboards:
    profiles:
      - never

# ==========================================================================
# Production Volumes
# ==========================================================================
volumes:
  yeto-db-data-prod:
    driver: local
  yeto-db-logs:
    driver: local
  traefik-certs:
    driver: local
